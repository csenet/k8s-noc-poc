-- dnsdist configuration with dynamic backend discovery
-- Backends are resolved from the Unbound headless Service and
-- automatically synced every 10 seconds via maintenance().

local HEADLESS = "unbound-headless.noc-poc.svc.cluster.local"
local SYNC_INTERVAL = 10 -- seconds

-- Resolve headless service FQDN to a set of pod IPs
local function resolvePods()
  local ips = {}
  local handle = io.popen("getent ahostsv4 " .. HEADLESS .. " 2>/dev/null | awk '{print $1}' | sort -u")
  if handle then
    for line in handle:lines() do
      if line:match("^%d+%.%d+%.%d+%.%d+$") then
        ips[line] = true
      end
    end
    handle:close()
  end
  return ips
end

-- Register initial backends
local initialPods = resolvePods()
for ip, _ in pairs(initialPods) do
  newServer({address=ip .. ":53", name=ip, checkInterval=5, checkTimeout=2000, maxCheckFailures=3, rise=2})
end

setServerPolicy(leastOutstanding)
setLocal("0.0.0.0:53", {reusePort=true})

-- DNS over TLS (DoT) listener on port 853
addTLSLocal("0.0.0.0:853", "/etc/dnsdist/tls/tls.crt", "/etc/dnsdist/tls/tls.key")

-- Prometheus metrics
webserver("0.0.0.0:8083")
setWebserverConfig({apiKey="dnsdist-api-key", statsRequireAuthentication=false})
setACL({"0.0.0.0/0"})

-- Periodic backend sync: add new pods, remove departed pods
local syncTick = 0
function maintenance()
  syncTick = syncTick + 1
  if syncTick % SYNC_INTERVAL ~= 0 then return end

  local currentPods = resolvePods()

  -- Build map of existing backends: ip -> server object
  local existing = {}
  for _, s in ipairs(getServers()) do
    existing[s.name] = s
  end

  -- Add new pods
  for ip, _ in pairs(currentPods) do
    if not existing[ip] then
      newServer({address=ip .. ":53", name=ip, checkInterval=5, checkTimeout=2000, maxCheckFailures=3, rise=2})
      infolog("Backend added: " .. ip)
    end
  end

  -- Remove departed pods (collect first, then remove to avoid index issues)
  local toRemove = {}
  for ip, s in pairs(existing) do
    if not currentPods[ip] then
      table.insert(toRemove, s)
    end
  end
  for _, s in ipairs(toRemove) do
    rmServer(s)
    infolog("Backend removed: " .. s.name)
  end
end
