apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: noc-poc

configMapGenerator:
  - name: unbound-config
    behavior: merge
    files:
      - configs/forward-zones.conf
    options:
      disableNameSuffixHash: true

resources:
  - ../../base/namespace
  - ../../base/redis
  - ../../base/unbound
  - ../../base/dnsdist
  - ../../base/mariadb
  - ../../base/kea-dhcp
  - patches/kea-metrics-service.yaml

patches:
  - path: patches/dnsdist-service.yaml
  - path: patches/kea-service.yaml
  # Kea ConfigMap: override lease-database to use MariaDB
  - path: patches/kea-configmap.yaml
  # Kea StatefulSet: install mysql client + share to main container
  - path: patches/kea-statefulset.yaml
  # Helm rendered resources don't get namespace transformer applied,
  # so we force namespace on all kea-dhcp and mariadb resources
  - target:
      labelSelector: app.kubernetes.io/name=kea-dhcp
    patch: |
      - op: add
        path: /metadata/namespace
        value: noc-poc
  - target:
      kind: ConfigMap
      name: kea-dhcp
    patch: |
      - op: add
        path: /metadata/namespace
        value: noc-poc
  - target:
      labelSelector: app.kubernetes.io/name=mariadb
    patch: |
      - op: add
        path: /metadata/namespace
        value: noc-poc
  - target:
      kind: ConfigMap
      name: mariadb
    patch: |
      - op: add
        path: /metadata/namespace
        value: noc-poc
  - target:
      kind: Secret
      name: mariadb
    patch: |
      - op: add
        path: /metadata/namespace
        value: noc-poc
